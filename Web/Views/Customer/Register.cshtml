@model Utility.Models.Frontend.CustomerManagement.CustomerModel
@{
    var breadCrumbItems = new List<BreadcrumbModel>(); 
    breadCrumbItems.Add(new BreadcrumbModel() { Url = "SignUp", Title = SharedHtmlLocalizer["SignUp"].Value });    
}
@await Html.PartialAsync("_PageHeading", breadCrumbItems)
<section class="main-content py-5 mb-5" id="sec-register" >
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6 col-xl-4 mx-auto">
                <div class="card mt-3 mt-md-0 rounded-5 border-secondary shadow">
                    <div class="card-body">
                        <form  method="post" autocomplete="off" class="row g-3 p-3" id="register-form">
                            <div asp-validation-summary="ModelOnly"></div>
                            <div class="col-12">
                                <label for="inputName" class="form-label mb-0">@SharedHtmlLocalizer["Name"]<span class="ms-1 text-danger">*</span></label>
                                <input type="text" asp-for="Name" class="form-control body-bg-secondary rounded-pill border-secondary"  placeholder="Enter your name">
                            </div>

                            <div class="col-md-12">
                                <label for="inputMobile" class="form-label mb-0">@SharedHtmlLocalizer["MobileNumber"]<span class="ms-1 text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text rounded-pill rounded-end border border-end-0 border-secondary pe-0">
                                        <img src="~/assets/img/Kuwait_flag.svg" width="25">
                                    </span>
                                    <span class="input-group-text border border-secondary border-start-0 p-1" id="basic-addon1">
                                        <bdi>+965</bdi>
                                    </span>
                                    <input type="tel" asp-for="MobileNumber"
                                           class="form-control border-start-0 rounded-start rounded-pill border-secondary body-bg-secondary"
                                           aria-label="@SharedHtmlLocalizer["EnterYourMobileNumber"]"
                                           maxlength="8" onkeypress="return validateMobileNumber(event);"
                                           placeholder="" />
                                    <div class="invalid-feedback" id="dvError">
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="inputEmail4" class="form-label mb-0">@SharedHtmlLocalizer["Email"]</label>
                                <input type="email" asp-for="EmailAddress"
                                       class="form-control body-bg-secondary rounded-pill border-secondary"
                                       placeholder="@SharedHtmlLocalizer["EnterYourEmailAddress"]">
                            </div>
                            <div class="col-12 col-lg-9 mx-auto">
                                <div class="form-check">
                                    <input class="form-check-input mt-0 me-2" type="checkbox" id="gridCheck">
                                    <label class="form-check-label d-block" for="gridCheck">
                                        I agree to the
                                        <a href="javascript:;" class="text-primary fw-bold privacy-policy">@SharedHtmlLocalizer["PrivacyPolicy"]</a> &
                                        <a href="javascript:;" class="text-primary fw-bold terms-and-conditions">@SharedHtmlLocalizer["TermsAndConditions"]</a>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 text-center">
                                <a href="javascript:;" id="signup-btn" class="btn btn-primary color-white rounded-pill fw-bold px-5" >@SharedHtmlLocalizer["SignUp"]</a>

                            </div>

                            <button class="btn btn-outline-secondary rounded-start rounded-pill body-bg-secondary fw-bold otp-code-button"
                                    data-bs-toggle="modal" data-bs-target="#OTPModal" type="button"
                                    style="display:none">
                                @SharedHtmlLocalizer["Verify"]
                            </button>
                             

                            <div class="col-12 text-center">
                                <hr class="dropdown-divider body-bg-secondary border-secondary">
                            </div>
                            <div class="col-12 text-center">
                                <h6 class="mb-2">@SharedHtmlLocalizer["AlreadyHaveAnAccount"]</h6>
                                <a href="@Url.RouteUrl("signin")" class="btn btn-secondary rounded-pill px-5 fw-bold text-white">@SharedHtmlLocalizer["SignIn"]</a>
                            </div> 
                        </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


<div class="modal fade"  id="OTPModal" tabindex="-1" aria-labelledby="OTPModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary" id="OTPModalTitle">@SharedHtmlLocalizer["VerifyMobileNumber"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@SharedHtmlLocalizer["Close"]"></button>
            </div>
            <div class="modal-body">

                <div class="row">
                    <div class="col-12 ">
                        <div class="bg-light-secondary p-4 rounded">
                            <form>
                                <div class="row justify-content-center">
                                    <div class="col-12 text-center">
                                        <div class="col-sm-12 text-center">
                                            <p class="mb-0" id="pVerificationMessage"></p>
                                        </div>
                                        @*Please enter OTP code which has been sent to Mobile Number<br> <span class="fw-bold" id="verifyMobile"></span>*@
                                    </div>
                                    <div class="col-12 col-lg-8">
                                        <div id="otp" class="row align-items-center ">
                                            <div class="col-3 my-1">
                                                <input type="number" class="form-control rounded-3 text-center fs-4" placeholder="" id="otp1" min="0" max="9" maxlength="1" pattern="[0-9]">
                                            </div>
                                            <div class="col-3 my-1">
                                                <input type="number" class="form-control rounded-3 text-center fs-4" placeholder="" id="otp2" min="0" max="9" maxlength="1" pattern="[0-9]">
                                            </div>
                                            <div class="col-3 my-1">
                                                <input type="number" class="form-control rounded-3 text-center fs-4" placeholder="" id="otp3" min="0" max="9" maxlength="1" pattern="[0-9]">
                                            </div>
                                            <div class="col-3 my-1">
                                                <input type="number" class="form-control rounded-3 text-center fs-4" placeholder="" id="otp4" min="0" max="9" maxlength="1" pattern="[0-9]">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12 text-center">
                                <div id="timer" class="mb-3">04:59</div>
                            </div>
                            <div class="col-12 text-center">
                                <button id="resend" type="button" class="btn btn-secondary text-light rounded-pill me-1">@SharedHtmlLocalizer["ResendOTP"]</button>
                                <a href="#" id="otp-verify-btn" class="btn btn-primary rounded-pill ms-1 verify-otp-button" >@SharedHtmlLocalizer["VerifyOTP"]</a>
                                <input type="hidden" id="requestId" />
                            </div>
                        </div>


                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        $("#resend").hide();
       // $('#OTPModal').hide();
        $("#register-form").validate({
            rules: {
                Name: {
                    required: true
                },
                EmailAddress: {
                    required: true, email: true
                },
                MobileNumber: {
                    required: true, rangelength: [8, 8], phoneStartCheck: true
                }
            },
            messages: {
                Name: {
                    required: "<div class='invalid-feedback' style='display:block !important;'><span>@SharedHtmlLocalizer["NameIsRequired"]</span></div>",
                },
                EmailAddress: {
                    required: "<div class='invalid-feedback' style='display:block !important;'><span>@SharedHtmlLocalizer["EmailIsRequired"]</span></div>",
                    email: "<div class='invalid-feedback' style='display:block !important;'><span>@SharedHtmlLocalizer["EnterAValidEmail"]</span></div>",
                },
                MobileNumber: {
                    required: "<div class='invalid-feedback' style='display:block !important;'><span>@SharedHtmlLocalizer["MobileNumberIsRequired"]</span></div>",
                    rangelength: "<div class='invalid-feedback' style='display:block !important;'><span>@SharedHtmlLocalizer["MobileNumberShouldBe8Digits"]</span></div>",
                    phoneStartCheck: "<div class='invalid-feedback' style='display:block !important;'><span>@SharedHtmlLocalizer["EnterAValidMobileNumber"]</span></div>"
                }
            },
            errorPlacement: function ($error, $element) {
                var name = $element.attr("name");
                $("#dvError" + name).append($error);
            }
        });

        $("#signup-btn").click(function (event) {
            event.preventDefault();
            $('#register-form').validate();
            if ($("#register-form").valid()) {
                var name = $("#Name").val();
                var mobileNumber = $("#MobileNumber").val();
                var email = $("#EmailAddress").val();
                $("#verifyMobile").text("+965" + mobileNumber);

                $.post("@Url.RouteUrl("register")", {
                    Name: name,
                    MobileNumber: mobileNumber,
                    EmailAddress: email
                }, function (result) {
                    console.log(result);
                    //otp code sent to mobile number
                    if (result.success) {
                        //$("#sec-register").hide();
                        $("#pVerificationMessage").text(result.message);
                        $("#requestId").val(result.data.otpDetailId);

                        WindowWidth = $(window).width();
                        WindowHeight = $(window).height();
                        BodyHeight = $('body').height();
                        if (BodyHeight < WindowHeight) {
                            if (WindowWidth > 768) {
                                $('footer').attr('class', 'fixed-bottom')
                            }
                        }
                        else {
                            $('footer').removeClass('fixed-bottom')
                        }

                        var time = millisToMinutesAndSeconds(result.data.millisecondsForExpiry);
                        document.getElementById('timer').innerHTML = time;
                        startTimer();
                        $("#resend").hide();
                        $("#otp-verify-btn").show();

                        let myModal = new bootstrap.Modal(document.getElementById('OTPModal'), {});
                        myModal.show();
                    }
                    else {
                        if (result.message != "")
                            ToastAlert("error", "",result.message);
                    }
                });
            }
        });

        $("#otp-verify-btn").on("click", function () {
            var requestId = $("#requestId").val();
            if (requestId.length == 0)
                return;

            var otp = $("#otp1").val() + $("#otp2").val() + $("#otp3").val() + $("#otp4").val();
            if (otp == "") {
                ToastAlert("error", "","@SharedHtmlLocalizer["OTPIsRequired"]");
                return;
            }

            var deviceId = "";
            var deviceToken = "";
            var typeId = @((int)NotificationType.Register);

            $.post("@Url.RouteUrl("verifyOTP")", {
                RequestId: requestId, OTP: otp, DeviceId: deviceId, DeviceToken: deviceToken, TypeId: typeId
            }, function (result) {
                console.log(result);
                if (result.success) {
                        $('.verified-check').show();
                        $('#OTPModal').modal('hide'); 
                    window.location.href = "@Url.RouteUrl("home")";
                }
                else {
                    if (result.message != "")
                        ToastAlert("error", "Alert", result.message);
                }
            });
        });


        $("#resend").click(function () {
            $("#otp1").val('');
            $("#otp2").val('');
            $("#otp3").val('');
            $("#otp4").val('');

            var otpDetailId = $("#requestId").val();
            if (otpDetailId.length == 0)
                return;

            $.get("@Url.RouteUrl("resendOTP")", { otpDetailId: otpDetailId }, function (result) {
                if (result.success) {
                    $("#requestId").val(result.data.otpDetailId);
                    var time = millisToMinutesAndSeconds(result.data.millisecondsForExpiry);
                    document.getElementById('timer').innerHTML = time;
                    startTimer();
                    $("#resend").hide();
                    $("#otp-verify-btn").show();
                }
                else {
                    if (result.message != "")
                        ToastAlert("error","Alert",result.message);
                }
            });
        });
    });

    function OTPInput() {
        var inputs = document.querySelectorAll('#otp  *[id]');
        for (let i = 0; i < inputs.length; i++) {
            inputs[i].addEventListener('keydown', function (event) {
                if (event.key === "Backspace") {
                    inputs[i].value = '';
                    if (i !== 0) {
                        inputs[i - 1].focus();
                        var txtOtp = inputs[i - 1].id;
                        $("#" + txtOtp).removeAttr("readonly");
                    }
                } else {
                    if (inputs[i].value !== '') {
                        event.preventDefault();
                    } else if ((event.keyCode > 47 && event.keyCode < 58) || (event.keyCode >= 96 && event.keyCode <= 105)) {
                        if (inputs[i].value !== '') {


                        } else {
                            inputs[i].value = event.key;
                            if (i !== inputs.length - 1) {
                                inputs[i + 1].focus();
                                var txtOtp = inputs[i + 1].id;
                                $("#" + txtOtp).removeAttr("readonly");
                            }
                            event.preventDefault();
                        }
                    } else if (event.keyCode > 64 && event.keyCode < 91) {
                        inputs[i].value = String.fromCharCode(event.keyCode);
                        event.preventDefault();
                    }
                }
            });
        }
    }

    OTPInput();

    function startTimer() {

        var presentTime = document.getElementById('timer').innerHTML;
        var timeArray = presentTime.split(/[:]+/);

        var m = timeArray[0];
        var s = checkSecond((timeArray[1] - 1));
        if (s == 59) {
            m = m - 1
        }
        if (m < 0) {
            return
        }
        document.getElementById('timer').innerHTML = m + ":" + s;
        console.log(m);
        if (m === '0' && s === '00') {
            $("#resend").show();
            $("#otp-verify-btn").hide();
        } else {
            setTimeout(startTimer, 1000);
        }
    }

    function checkSecond(sec) {
        if (sec < 10 && sec >= 0) {
            sec = "0" + sec
        };
        if (sec < 0) {
            sec = "59"
        };
        return sec;
    }

    function millisToMinutesAndSeconds(millis) {
        var minutes = Math.floor(millis / 60000);
        var seconds = ((millis % 60000) / 1000).toFixed(0);
        return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
    }
</script>